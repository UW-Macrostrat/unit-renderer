<!DOCTYPE html>
<meta charset="utf-8">
<title>Macrostrat section renderer</title>
<style>

.node {
  fill: #ddd;
  stroke: #000;
  stroke-width: 0.01em;
}

.label {
  font: 10px sans-serif;
  text-anchor: middle;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  cursor: default;
}

#column, #column2 {
  display: inline;
}

</style>
<body>
  <div id="column"></div>
  <div id="column2"></div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<!--<script src="d3.v3.min.js"></script>-->
<script>
/*
  1. Create Member-group-unit hierarchy, where applicable
  4. Texture units based on 'lith'
  5. Handle text display properly
  4. Scrollable?
*/
var baseURL = (window.location.hostname === "localhost") ? "http://localhost:5000" : "http://dev.macrostrat.org",
    units = {
      width: 600,
      height: 800
    },
    intervals = {
      width: 50,
      height: 800
    }

function getSection(id) {
  d3.json(baseURL + "/api/units?response=long&section_id=" + id, function(error, data) {
    units.data = data.success.data;

    var late_age = d3.min(units.data, function(d) { return d.LO_age }),
        early_age = d3.max(units.data, function(d) { return d.FO_age });
    
    getTimeIntervals(early_age, late_age);

  });
}


function getTimeIntervals(early, late) {
  // 1. Find all periods that cross this range
  d3.json(baseURL + "/api/defs/intervals?timescale=international&early_age=" + early + "&late_age=" + late, function(error, data) {
    // 2. Check if any periods were returned
    var periods = data.success.data.filter(function(d) {
      if (d.type === "period") {
        return d;
      }
    });

    // 2B. If no periods returned, find the period that intersects the midpoint time of this section
    if (periods.length < 1) {
      d3.json(baseURL + "/api/defs/intervals?timescale=international&age=" + parseInt(((early + late) / 2)), function(error, data) {
        verifyIntervals(early, late, data.success.data);
      });

    // 2A. If at least one period was returned, carry on our wayward song
    } else {
      verifyIntervals(early, late, periods);
    }
  
  });
}

function verifyIntervals(early, late, periods) {
  // If the latest age of the periods doesn't cover our range, go get the period that does
  if (d3.min(periods, function(d) { return d.late_age }) > late) {
    // Not late enough
    d3.json(baseURL + "/api/defs/intervals?timescale=international&age=" + late, function(error, data) {
      var period = data.success.data.filter(function(d) {
        if (d.type === "period") {
          return d;
        }
      });
      periods.push(period[0]);
      getAllIntervals(periods);
    });
  // If the earliest age of the periods doesn't cover our range, go get the period that does
  } else if (d3.max(periods, function(d) { return d.early_age }) < early) {
    // Not early enough
    d3.json(baseURL + "/api/defs/intervals?timescale=international&age=" + early, function(error, data) {
      var period = data.success.data.filter(function(d) {
        if (d.type === "period") {
          return d;
        }
      });
      periods.push(period[0]);
      getAllIntervals(periods);
    }); 
  // Otherwise, carry on lad
  } else {
    getAllIntervals(periods);
  }
}

function getAllIntervals(periods) {
  // 3. Find the late_age and early_age of all periods returned
  var late = d3.min(periods, function(d) { return d.late_age }),
      early = d3.max(periods, function(d) { return d.early_age });

  // Draw the units
  units.scale = d3.scale.linear()
    .domain([late, early])
    .range([0, 800]);

  drawUnits();

  // 4. Basically redo #1, but with this new range
  // Find all intervals in this period
  d3.json(baseURL + "/api/defs/intervals?timescale=international&early_age=" + early + "&late_age=" + late, function(error, data) {
    draw(data.success.data)
  });

}

function draw(data) {

  d3.select("#column").select("svg").remove();

  var svg = d3.select("#column").append("svg")
      .attr("width", intervals.width)
      .attr("height", intervals.height)
      .append("g")
        .attr("id", "timescale")
        .attr("data-zoomed", "false");;

  var scale = d3.scale.linear()
      .domain([d3.min(data, function(d) { return d.late_age }), d3.max(data, function(d) { return d.early_age})])
      .range([0, intervals.height])

  var interval_lookup = {
    "period": 0,
    "epoch": intervals.width * 0.3,
    "age": intervals.width * 0.6
  }

  intervals.interval_lookup = interval_lookup;

  svg.selectAll(".node")
    .data(data)
  .enter().append("rect")
    .attr("class", "node interval_node")
    .attr("id", function(d) { return "n" + d.id })
    .attr("x", function(d) { return interval_lookup[d.type] })
    .attr("y", function(d) { return scale(d.late_age) })
    .attr("width", intervals.width * 0.3)
    .attr("height", function(d) { return scale(d.early_age) - scale(d.late_age)})
    .style("fill", function(d) { return d.color })
    .on("click", function(d) {
      zoom(d.id);
    });

  svg.selectAll(".label")
    .data(data)
  .enter().append("text")
    .attr("class", "label interval_label")
    .attr("id", function(d) { return "nl" + d.id })
    .attr("dy", ".35em")
    .attr("transform", function(d) { return "translate(" + (interval_lookup[d.type] + ((intervals.width * 0.3)/2)) + "," + ((scale(d.late_age) + scale(d.early_age))/2) + ")rotate(-90)"; })
    .text(function(d) { return d.name; })
    .on("click", function(d) {
      zoom(d.id);
    });

  displayLabelsIntervals();
}

function zoom(id) {
  if (d3.select("#timescale").attr("data-zoomed") === "false") {
    
    var scaleY = units.height/d3.select("#n" + id).attr("height"),
        translate = d3.select("#n" + id).attr("y") * scaleY;

    zoomIn(scaleY, translate);

  } else {
    zoomOut();
  }

}


function zoomOut() {
  // Indicate that we are zoomed out
  d3.select("#timescale")
    .attr("data-zoomed", "false");

  // Reset the timescale
  d3.selectAll(".interval_node")
    .transition()
    .duration(1000)
    .attr("height", function(d) {
      return units.scale(d.early_age) - units.scale(d.late_age);
    })
    .attr("y", function(d) {
      return units.scale(d.late_age);
    });

  var x = 0;
  // Reset the time interval labels
  d3.selectAll(".interval_label")
    .transition()
    .duration(1000)
    .each(function(){ ++x; })
    .attr("transform", function(d) { 
      return "translate(" + (intervals.interval_lookup[d.type] + ((intervals.width * 0.3)/2)) + "," + ((units.scale(d.late_age) + units.scale(d.early_age))/2) + ")rotate(-90)"; 
    })
    .each("end", function() { if (!--x) { displayLabelsIntervals() }});

  // Reset the section
  d3.selectAll(".unit_node")
    .transition()
    .duration(1000)
    .attr("y", function(d) { return units.scale(d.t_age) })
    .attr("height", function(d) { return units.scale(d.b_age) - units.scale(d.t_age)});

  var n = 0;
  // Reset the unit labels 
  d3.selectAll(".unit_label")
    .transition()
    .duration(1000)
    .each(function(){ ++n; })
    .attr("transform", function(d) { return "translate(" + (units.column_x_lookup[d.col] + (units.width/units.columns.length)/2)  + "," + (units.scale(d.t_age) + (units.scale(d.b_age) - units.scale(d.t_age))/2) + ")" })
    .each("end", function() { if (!--n) { displayLabelsUnits() }});
}


function zoomIn(scaleF, translate) {
  // Indicate that we are zoomed in
  d3.select("#timescale")
    .attr("data-zoomed", "true");

  // Zoom the timescale
  d3.selectAll(".interval_node")
    .transition()
    .duration(1000)
    .each(function(){ ++x; })
    .attr("height", function(d) {
      return (units.scale(d.early_age) - units.scale(d.late_age)) * scaleF;
    })
    .attr("y", function(d) {
      return (d3.select(this).attr("y") * scaleF) - translate;
    });

  var x = 0;

  // Readjust the time interval labels
  d3.selectAll(".interval_label")
    .transition()
    .duration(1000)
    .each(function(){ ++x; })
    .attr("transform", function(d) {
      var currentTransform = d3.transform(d3.select(this).attr("transform")).translate,
          x = currentTransform[0],
          y = currentTransform[1];
      return "translate(" + x  + "," + ((y * scaleF) - translate) + ")rotate(-90)" 
    })
    .each("end", function() { if (!--x) { displayLabelsIntervals() }});

  // Zoom the section
  d3.selectAll(".unit_node")
    .transition()
    .duration(1000)
    .attr("height", function(d) { 
      return (units.scale(d.b_age) - units.scale(d.t_age)) * scaleF
    })
    .attr("y", function(d) { 
      return (d3.select(this).attr("y") * scaleF) - translate;
    });

  var n = 0;
  // Readjust the unit labels
  d3.selectAll(".unit_label")
    .transition()
    .duration(1000)
    .each(function(){ ++n; })
    .attr("transform", function(d) {
      var currentTransform = d3.transform(d3.select(this).attr("transform")).translate,
          x = currentTransform[0],
          y = currentTransform[1];
      return "translate(" + x  + "," + ((y * scaleF) - translate) + ")" 
    })
    .each("end", function() { if (!--n) { displayLabelsUnits() }});
}

function displayLabelsUnits() {
  d3.selectAll(".unit_label")
    .style("display", function(d) {
      var textHeight = d3.select("#ul" + d.id).node().getBBox().height,
          boxHeight = d3.select("#u" + d.id).attr("height");

      if (textHeight > boxHeight) {
        return "none";
      } else {
        return "block";
      }
    });
}

function displayLabelsIntervals() {
  d3.selectAll(".interval_label")
    .style("display", function(d) {
      var textHeight = d3.select("#nl" + d.id).node().getBBox().width,
          boxHeight = d3.select("#n" + d.id).attr("height") - 10;

      if (textHeight > boxHeight) {
        return "none";
      } else {
        return "block";
      }
    });
}

function drawUnits() {
  var columns = [
    {
      'top': -1,
      'bottom': -1
    }
  ];
  units.data.forEach(function(d) {
    if (d.t_age > d.b_age) {
      console.log(d.strat_name + " IS BASS ACKWARDS");
      return;
    }
    var found = false;
    for (var i=0; i<columns.length; i++) {
      if (d.t_age >= columns[i].top && d.b_age <= columns[i].bottom) {
        // add new column
        console.log("a - " + d.strat_name)
      } else if (d.t_age < columns[i].top && d.b_age > columns[i].top) {
        // add new column
        console.log("b - " + d.strat_name)
      } else if (d.t_age < columns[i].bottom && d.t_age > columns[i].top) {
        // add new column
        console.log("c - " + d.strat_name)
      } else {
        console.log("d - " + d.strat_name)
        if (columns[i].top < 0) {
          columns[i].top = d.t_age;
        }

        columns[i].bottom = d.b_age;
        found = true;
        d.col = i;
        return;
      }
    }


    if (!found) {
      columns.push({'top': d.t_age, 'bottom': d.b_age});
      d.col = columns.length - 1;
    }

  });

  var column_x_lookup = {
      0: 0,
      1: units.width/columns.length,
      2: units.width/columns.length + units.width/columns.length
    }

  units.columns = columns;
  units.column_x_lookup = column_x_lookup;
      
  var svg = d3.select("#column2").append("svg")
    .attr("width", units.width)
    .attr("height", units.height)
    .append("g")
      .attr("id", "section");

  svg.selectAll(".units")
    .data(units.data)
  .enter().append("rect")
    .attr("class", "node unit_node")
    .attr("id", function(d) { return "u" + d.id })
    .attr("x", function(d) { return units.column_x_lookup[d.col] })
    .attr("y", function(d) { return units.scale(d.t_age) })
    .attr("width", units.width/columns.length)
    .attr("height", function(d) { return units.scale(d.b_age) - units.scale(d.t_age)})
    .style("fill", function(d) { return d.color });

  d3.select("#column2")
    .select("svg")
  .append("g")
    .attr("id", "unit_labels")
  .selectAll(".unit_label")
    .data(units.data)
  .enter().append("text")
    .attr("class", "label unit_label")
    .attr("id", function(d) { return "ul" + d.id })
    .attr("dy", ".35em")
    .attr("transform", function(d) { return "translate(" + (units.column_x_lookup[d.col] + (units.width/columns.length)/2)  + "," + (units.scale(d.t_age) + (units.scale(d.b_age) - units.scale(d.t_age))/2) + ")" })
    .style("fill", function(d) { return d.text_color })
    .text(function(d) { return d.strat_name; });
  
  displayLabelsUnits();
}


var section = window.location.hash.replace("#/", "");
if (section.length > 0) {
  getSection(section);
} else {
  getSection(4258);
}


</script>

